<!doctype html>
<!-- =========================================================
     ESTUDIANT – App de Examen Offline (v.Final para iOS/Local)
     BEM + Buenas prácticas + Un solo contenedor (.app)
     Funciona 100% online (Netlify/GitHub Pages) y en local (PC/Mac)
     ========================================================= -->
<html lang="es">
<head>
  <!-- =================== Metadatos =================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESTUDIANT</title>

  <!-- =================== CSS (BEM) =================== -->
  <style>
    /* ===== Paleta / Tema ===== */
    :root{
      --bg:#0b1020; --bg-2:#0e1530; --card:#121a33;
      --text:#e9efff; --muted:#a9b7db; --border:#22305c;
      --accent:#5dd0ff; --ok:#35d49a; --bad:#ff6b6b; --warn:#ffd166;
    }

    /* ===== Reset mínimo ===== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      color:var(--text); background:linear-gradient(180deg,var(--bg),var(--bg-2) 45%,var(--bg));
    }

    /* =========================================================
       Bloque ÚNICO: .app  (contenedor raíz)
       ========================================================= */
    .app{max-width:1040px; margin:28px auto; padding:0 16px}
    .app__header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px}
    .app__title{margin:0 0 6px; font-size:1.6rem; letter-spacing:.02em}
    .app__subtitle{margin:0; color:var(--muted)}
    .app__toolbar{display:flex; flex-wrap:wrap; gap:10px}
    .app__stats{color:var(--muted); font-size:.95rem; display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px}
    .app__list{margin-top:12px}
    .app__footer{margin:22px 0 38px; color:var(--muted); font-size:.9rem}

    /* ===== Botones ===== */
    .app__btn{appearance:none; border:none; border-radius:10px; padding:10px 14px;
              background:#1a2548; color:var(--text); cursor:pointer;
              border:1px solid var(--border); transition:transform .05s ease, background .2s ease}
    .app__btn:hover{background:#1e2b56}
    .app__btn:active{transform:scale(.98)}
    .app__btn[disabled]{opacity:.55; cursor:not-allowed}
    .app__btn--accent{background:#1a364f; border-color:#2b6ca0}
    .app__btn--ok{background:#163b2f; border-color:#1f7a5f}
    .app__btn--warn{background:#3d2f13; border-color:#906d26}
    .app__btn--danger{background:#4a1f1f; border-color:#8a3030}

    /* ===== Píldoras ===== */
    .app__pill{padding:.1rem .5rem; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:.78rem}

    /* =========================================================
       Elemento: panel (importación / modo / resumen CSV)
       ========================================================= */
    .app__panel{margin:10px 0 12px}
    .app__panel-summary{cursor:pointer; color:var(--accent)}
    .app__panel-body{border:1px solid var(--border); background:#0f1732; padding:12px; border-radius:12px; margin-top:8px; display:grid; gap:10px}
    .app__panel-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .app__panel-input{padding:8px; border-radius:8px; border:1px solid var(--border); background:#0b132a; color:var(--text)}
    .app__panel-textarea{width:100%; min-height:120px; padding:10px; border-radius:8px; border:1px solid var(--border); background:#0b132a; color:var(--text); resize:vertical; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .app__panel-hint{color:var(--muted); font-size:.9rem}

    /* =========================================================
       Elemento: card (pregunta)
       ========================================================= */
    .app__card{background:rgba(18,26,51,.86); border:1px solid var(--border); border-radius:14px; padding:16px 16px 10px; margin:14px 0}
    .app__card--ok{border-left:6px solid var(--ok)}
    .app__card--bad{border-left:6px solid var(--bad)}
    .app__card-head{display:flex; gap:8px; margin-bottom:6px}
    .app__card-tag{font-size:.8rem; color:#9fb0d4; background:#162149; border:1px solid var(--border); padding:2px 8px; border-radius:999px}
    .app__card-title{margin:0; font-size:1.02rem}
    .app__card-options{display:grid; gap:10px; margin:10px 0 6px}
    .app__card-option{display:flex; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0f1732}
    .app__card-option input{margin-top:2px; transform:scale(1.15)}
    .app__card-option--correct{outline:2px solid rgba(53,212,154,.7); background:#0f1f1a}
    .app__card-option--wrong{outline:2px solid rgba(255,107,107,.65); background:#281515}
    .app__card-actions{display:flex; gap:8px; margin-top:8px}
    .app__card-hint{font-size:.9rem; color:var(--muted); margin-left:auto}
    .app__card-feedback{margin-top:8px; font-weight:600}
    .app__card-feedback--ok{color:var(--ok)}
    .app__card-feedback--bad{color:var(--bad)}
    .app__card-feedback--muted{color:var(--muted)}
    .app__card-exp{margin-top:8px; padding:10px 12px; border:1px dashed var(--border); border-radius:10px; color:var(--muted); background:#0e1630; display:none}

    /* ===== Modificadores de modo sobre el contenedor ===== */
    .app--exam .app__card-actions{display:none}
    .app--exam .app__card-exp{display:none !important}
    .app--exam #pill-timer{display:inline-block}
    #pill-timer{display:none}
    .app--exam #pill-score{visibility:hidden}
    .app--exam.app--finished #pill-score{visibility:visible}
    .app--exam.app--finished .app__card input[type="radio"]{pointer-events:none}
  </style>
</head>
<body>
  <!-- =========================================================
       HTML – CONTENEDOR ÚNICO (Bloque: .app)
       ========================================================= -->
  <div class="app" id="app">
    <!-- Header -->
    <header class="app__header">
      <div>
        <h1 class="app__title">ESTUDIANT</h1>
        <p class="app__subtitle" id="txt-subtitle">Uso online/offline. Importar JSON/CSV, modo repaso y examen, exportar CSV.</p>
      </div>
      <div class="app__toolbar">
        <button id="btn-shuffle"    class="app__btn app__btn--accent">Mezclar</button>
        <button id="btn-check-all"  class="app__btn app__btn--ok">Corregir todo</button>
        <button id="btn-reset"      class="app__btn app__btn--warn">Reiniciar</button>
        <button id="btn-export"     class="app__btn app__btn--ok">Exportar CSV</button>
        <input  id="file-csv" type="file" accept=".csv,text/csv" style="display:none">
        <button id="btn-import-csv" class="app__btn app__btn--accent">Importar CSV</button>
        <button id="btn-swap-label" class="app__btn app__btn--accent">Intercambiar etiquetas</button>
        <button id="btn-clear"      class="app__btn app__btn--danger">Borrar datos</button>
      </div>
    </header>

    <!-- Panel: Importar JSON -->
    <details class="app__panel" id="panel-import">
      <summary class="app__panel-summary">Cargar preguntas (JSON)</summary>
      <div class="app__panel-body">
        <div class="app__panel-row">
          <input id="file-json" type="file" accept="application/json" class="app__panel-input" />
          <button id="btn-load-file" class="app__btn app__btn--accent">Cargar archivo JSON</button>
          <span class="app__panel-hint">Recomendado para uso offline.</span>
        </div>
        <textarea id="txt-json" class="app__panel-textarea" placeholder='[{"q":"Pregunta 1","opts":["A","B","C","D"],"ans":0,"exp":"Explicación..."}]'></textarea>
        <div class="app__panel-row">
          <button id="btn-load-text" class="app__btn app__btn--ok">Cargar JSON pegado</button>
        </div>
      </div>
    </details>

    <!-- Panel: Modo repaso/examen -->
    <details class="app__panel" id="panel-mode">
      <summary class="app__panel-summary" id="txt-mode-summary">Modo examen</summary>
      <div class="app__panel-body">
        <div class="app__panel-row">
          <label>Duración (min):
            <input id="inp-minutes" type="number" min="1" max="300" value="20" class="app__panel-input">
          </label>
          <label><input id="chk-shuffle" type="checkbox" checked> Mezclar al iniciar</label>
          <span class="app__panel-hint" id="txt-mode-hint">Sin feedback hasta “Finalizar examen”.</span>
        </div>
        <div class="app__panel-row">
          <button id="btn-start"     class="app__btn app__btn--ok">Iniciar examen</button>
          <button id="btn-finish"    class="app__btn app__btn--warn">Finalizar examen</button>
          <button id="btn-resetmode" class="app__btn app__btn--danger">Reiniciar modo examen</button>
        </div>
      </div>
    </details>

    <!-- Panel: Resumen import CSV -->
    <details class="app__panel" id="panel-csv" style="display:none">
      <summary class="app__panel-summary">Resultado de la importación CSV</summary>
      <div class="app__panel-body" id="csv-summary"></div>
    </details>

    <!-- Estado -->
    <div class="app__stats">
      <span id="pill-score"  class="app__pill">Aciertos: 0 / 0</span>
      <span id="pill-timer"  class="app__pill">00:00</span>
      <span id="pill-dataset" class="app__pill">Dataset: por defecto</span>
      <span class="app__pill">Archivo único (HTML+CSS/JS)</span>
    </div>

    <!-- Lista de preguntas -->
    <div id="list" class="app__list"></div>

    <!-- Pie -->
    <footer class="app__footer">
      Para iOS/iPadOS: subir a Netlify/GitHub Pages. Para PC/Mac, funciona localmente con doble clic.
    </footer>
  </div>

  <!-- =================== JavaScript (IIFE) =================== -->
  <script>
  (function(){
    'use strict';

    /* ---------- Polyfills mínimos ---------- */
    if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector;}
    if(!Element.prototype.closest){Element.prototype.closest=function(s){let e=this;while(e&&e.nodeType===1){if(e.matches(s))return e;e=e.parentElement||e.parentNode;}return null;};}

    /* ---------- Utilidades ---------- */
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    const L=['A','B','C','D'];
    const now=()=>Date.now();
    const pad2=n=>String(n).padStart(2,'0');
    const fmt=ms=>`${pad2(Math.max(0,Math.floor(ms/60000)))}:${pad2(Math.max(0,Math.floor((ms%60000)/1000)))}`;
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function fp(obj){try{const s=JSON.stringify(obj);let h=0;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0;return'fp_'+h.toString(16);}catch{return'fp_0';}}
    function download(name,text){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([text],{type:'text/plain;charset=utf-8'}));a.download=name;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);}

    /* ---------- Claves de storage ---------- */
    const KEY={state:'app_state_vFinal', data:'app_data_vFinal', labels:'app_labels_vFinal'};

    /* ---------- DOM ---------- */
    const $root  =$('#app'), $list=$('#list'), $pillS=$('#pill-score'), $pillT=$('#pill-timer'), $pillD=$('#pill-dataset');
    const $panelCSV=$('#panel-csv'), $sumCSV=$('#csv-summary');
    const $txtModeSummary=$('#txt-mode-summary'), $txtModeHint=$('#txt-mode-hint'), $txtSubtitle=$('#txt-subtitle');

    /* ---------- Dataset por defecto (muestra) ---------- */
    const DEFAULT_EXAM = [
      {q:"En lógica proposicional, si P ⇒ Q y P es falsa y Q es verdadera, entonces P ⇒ Q es:", opts:["Verdadera","Falsa","Indeterminada","Depende del contexto"], ans:0, exp:"Solo es falsa con verdadero ⇒ falso."},
      {q:"A partir de P ⇒ Q y ¬Q, se deduce:", opts:["P","¬P","Q","P ∧ Q"], ans:1, exp:"Modus tollens."},
      {q:"Contrarrecíproca correcta:", opts:["¬X ⇒ ¬Y","¬Y ⇒ ¬X","Y ⇒ X","X ⇒ ¬Y"], ans:1, exp:"De “X ⇒ Y” se deduce “¬Y ⇒ ¬X”."},
      {q:"|A ∪ B| con |A|=20, |B|=15, |A∩B|=7:", opts:["22","28","34","12"], ans:1, exp:"20+15−7=28."},
      {q:"(A ∪ B)^c =", opts:["A^c ∩ B^c","A^c ∪ B^c","A ∪ B","A ∩ B"], ans:0, exp:"De Morgan."},
      {q:"¿Cuál es irracional?", opts:["0,12̅","√18/3","22/7","−5"], ans:1, exp:"√18/3=√2."},
      {q:"Cerrado para la resta:", opts:["ℕ","ℤ","ℚ+","ℝ\\ℚ"], ans:1, exp:"ℤ sí; ℕ no (3−5)."},
      {q:"Equivalente a 3/8:", opts:["9/24","6/10","12/40","15/48"], ans:0, exp:"×3/×3."},
      {q:"A ∩ B con A=(−2,4], B=[1,6):", opts:["(−2,6)","[1,4]","(−2,1)","[4,6)"], ans:1, exp:"Solape [1,4]."},
      {q:"(2/3 − 5/4)+1/6 =", opts:["−5/12","1/12","−1/12","−7/12"], ans:0, exp:"8/12−15/12+2/12."}
    ];

    /* ---------- Estado ---------- */
    let EXAM=[], EXAM_FP='fp_0', order=[], answers=[], result=[];
    let labelsMode = localStorage.getItem(KEY.labels)||'examen';
    let mode = {isExam:false,running:false,finished:false,durationMs:0,endAt:0,timer:null};

    /* ---------- Render ---------- */
    function render({shuffleOptions=false, resetOrder=true}={}){
      if(resetOrder) order=EXAM.map((_,i)=>i);
      $list.innerHTML='';
      order.forEach((oi,vi)=>{
        const it=EXAM[oi];
        const opts=it.opts.map((t,i)=>({t,i})); if(shuffleOptions) shuffle(opts);
        const card=document.createElement('div'); card.className='app__card'; card.dataset.viewIndex=vi; card.dataset.origIndex=oi;
        card.innerHTML=`
          <div class="app__card-head">
            <span class="app__card-tag">Pregunta ${vi+1}</span>
            <span class="app__card-tag">Opciones: 4</span>
          </div>
          <p class="app__card-title">${it.q}</p>
          <div class="app__card-options">
            ${opts.map((op,k)=>`
              <label class="app__card-option">
                <input type="radio" name="q${vi}" value="${op.i}">
                <div><strong>${L[k]}.</strong> ${op.t}</div>
              </label>`).join('')}
          </div>
          <div class="app__card-actions">
            <button class="app__btn app__btn--ok"  data-action="check">Comprobar</button>
            <button class="app__btn app__btn--warn" data-action="clear">Limpiar</button>
            <span class="app__card-hint">Responde y comprueba para ver la explicación.</span>
          </div>
          <div class="app__card-feedback app__card-feedback--muted" aria-live="polite">Sin responder.</div>
          <div class="app__card-exp"><strong>Explicación:</strong> ${it.exp}</div>`;
        $list.appendChild(card);
      });
      answers=Array(EXAM.length).fill(null);
      result =Array(EXAM.length).fill(null);
      updateStats();
    }

    /* ---------- Corrección ---------- */
    function checkCard(card,reveal=false){
      const vi=Number(card.dataset.viewIndex), oi=Number(card.dataset.origIndex), it=EXAM[oi];
      const sel=card.querySelector('input[type="radio"]:checked');
      const fb=card.querySelector('.app__card-feedback'), exp=card.querySelector('.app__card-exp');
      const boxes=[...card.querySelectorAll('.app__card-option')];
      if(!sel){ fb.className='app__card-feedback app__card-feedback--bad'; fb.textContent='Elige una opción antes de comprobar.'; exp.style.display=reveal?'block':'none'; return; }
      const chosen=Number(sel.value), ok=(chosen===it.ans); answers[vi]=chosen;
      if(!mode.isExam||reveal) result[vi]=ok;
      boxes.forEach(b=>b.classList.remove('app__card-option--correct','app__card-option--wrong'));
      card.classList.remove('app__card--ok','app__card--bad');
      boxes.forEach(b=>{ const v=Number(b.querySelector('input').value); if(v===it.ans&&(!mode.isExam||reveal)) b.classList.add('app__card-option--correct'); });
      if(!ok&&(!mode.isExam||reveal)){ sel.closest('.app__card-option').classList.add('app__card-option--wrong'); }
      if(!mode.isExam||reveal){
        fb.className= ok ? 'app__card-feedback app__card-feedback--ok':'app__card-feedback app__card-feedback--bad';
        fb.textContent= ok ? '¡Correcto!' : `Incorrecto. Respuesta correcta: "${it.opts[it.ans]}".`;
        card.classList.add(ok?'app__card--ok':'app__card--bad');
        exp.style.display='block';
      }else{ fb.className='app__card-feedback app__card-feedback--muted'; fb.textContent='Respuesta registrada.'; exp.style.display='none'; }
      saveState(); updateStats();
    }
    function clearCard(card){
      const vi=Number(card.dataset.viewIndex);
      [...card.querySelectorAll('input[type="radio"]')].forEach(i=>i.checked=false);
      card.querySelectorAll('.app__card-option').forEach(b=>b.classList.remove('app__card-option--correct','app__card-option--wrong'));
      card.classList.remove('app__card--ok','app__card--bad');
      const fb=card.querySelector('.app__card-feedback'); fb.className='app__card-feedback app__card-feedback--muted'; fb.textContent='Sin responder.';
      card.querySelector('.app__card-exp').style.display='none';
      answers[vi]=null; if(!mode.isExam) result[vi]=null;
      saveState(); updateStats();
    }

    /* ---------- Acciones globales ---------- */
    function updateStats(){ const ok=result.filter(v=>v===true).length; $pillS.textContent=`Aciertos: ${ok} / ${EXAM.length}`; $pillD.textContent=`Dataset: ${EXAM_FP===fp(DEFAULT_EXAM)?'por defecto':'personalizado'}`; }
    function checkAll(){ $$('.app__card').forEach(c=>checkCard(c, mode.isExam)); saveState(); }
    function resetAll(){ $$('.app__card').forEach(clearCard); saveState(); }
    function shuffleAll(){ order=shuffle(order); render({shuffleOptions:true, resetOrder:false}); saveState(); }

    /* ---------- Modo examen/repaso ---------- */
    function setPracticeDisabled(d){
      $('#btn-shuffle').disabled=d; $('#btn-check-all').disabled=d; $('#btn-reset').disabled=d;
      $('#btn-load-file').disabled=d; $('#btn-load-text').disabled=d; $('#file-json').disabled=d; $('#txt-json').disabled=d;
      $('#btn-import-csv').disabled=d; $('#file-csv').disabled=d;
    }
    function startExam(){
      if(mode.running) return;
      mode.isExam=true; mode.running=true; mode.finished=false;
      const mins=Math.max(1,Math.min(300,parseInt($('#inp-minutes').value||'20',10)));
      const doShuffle=$('#chk-shuffle').checked;
      render({shuffleOptions:doShuffle, resetOrder:true});
      $root.classList.add('app--exam'); $root.classList.remove('app--finished');
      mode.durationMs=mins*60000; mode.endAt=now()+mode.durationMs;
      startTimer(); setPracticeDisabled(true); saveState();
    }
    function finishExam(){
      if(!mode.isExam) return;
      mode.running=false; mode.finished=true; stopTimer();
      $$('.app__card').forEach(c=>checkCard(c,true));
      $$('.app__card input[type="radio"]').forEach(i=>i.disabled=true);
      $root.classList.add('app--finished'); setPracticeDisabled(false); saveState(); updateStats();
    }
    function resetMode(){
      stopTimer(); mode={isExam:false,running:false,finished:false,durationMs:0,endAt:0,timer:null};
      $root.classList.remove('app--exam','app--finished'); render({shuffleOptions:false, resetOrder:true});
      setPracticeDisabled(false); saveState();
    }
    function startTimer(){
      updateTimer(); mode.timer=setInterval(()=>{
        if(!mode.running){ stopTimer(); return; }
        if(mode.endAt<=now()) finishExam(); else updateTimer();
      },500);
    }
    function stopTimer(){ if(mode.timer){ clearInterval(mode.timer); mode.timer=null; } updateTimer(); }
    function updateTimer(){ const left=Math.max(0,mode.endAt-now()); $pillT.textContent=fmt(left); }

    /* ---------- Persistencia ---------- */
    function saveData(){ try{ localStorage.setItem(KEY.data, JSON.stringify({fp:EXAM_FP, exam:EXAM})); }catch{} }
    function loadData(){ try{ const raw=localStorage.getItem(KEY.data); if(!raw) return null; const o=JSON.parse(raw); return Array.isArray(o?.exam)?o:null; }catch{return null} }
    function saveState(){
      try{
        localStorage.setItem(KEY.state, JSON.stringify({
          fp:EXAM_FP, order, answers, result,
          mode:{isExam:mode.isExam,running:mode.running,finished:mode.finished,durationMs:mode.durationMs,endAt:mode.endAt},
          labels:labelsMode
        }));
      }catch{}
    }
    function loadState(){
      try{
        const raw=localStorage.getItem(KEY.state); if(!raw) return false;
        const o=JSON.parse(raw); if(!o||o.fp!==EXAM_FP) return false;
        if(o.labels){ labelsMode=o.labels; applyLabels(); }
        order  = Array.isArray(o.order)&&o.order.length===EXAM.length? o.order.slice(): EXAM.map((_,i)=>i);
        answers= Array.isArray(o.answers)? o.answers.slice(): Array(EXAM.length).fill(null);
        result = Array.isArray(o.result) ? o.result.slice() : Array(EXAM.length).fill(null);
        // Render respetando orden
        $list.innerHTML='';
        order.forEach((oi,vi)=>{
          const it=EXAM[oi];
          const card=document.createElement('div'); card.className='app__card'; card.dataset.viewIndex=vi; card.dataset.origIndex=oi;
          const opts=it.opts.map((t,i)=>({t,i}));
          card.innerHTML=`
            <div class="app__card-head"><span class="app__card-tag">Pregunta ${vi+1}</span><span class="app__card-tag">Opciones: 4</span></div>
            <p class="app__card-title">${it.q}</p>
            <div class="app__card-options">${opts.map((op,k)=>`<label class="app__card-option"><input type="radio" name="q${vi}" value="${op.i}"><div><strong>${L[k]}.</strong> ${op.t}</div></label>`).join('')}</div>
            <div class="app__card-actions"><button class="app__btn app__btn--ok" data-action="check">Comprobar</button><button class="app__btn app__btn--warn" data-action="clear">Limpiar</button><span class="app__card-hint">Responde y comprueba.</span></div>
            <div class="app__card-feedback app__card-feedback--muted" aria-live="polite">Sin responder.</div><div class="app__card-exp"><strong>Explicación:</strong> ${it.exp}</div>`;
          $list.appendChild(card);
        });
        answers.forEach((v,i)=>{ if(v!==null){ const inp=document.querySelector(`.app__card[data-view-index="${i}"] input[value="${v}"]`); if(inp) inp.checked=true; } });
        // Restaura modo
        if(o.mode){
          mode.isExam=!!o.mode.isExam; mode.running=!!o.mode.running; mode.finished=!!o.mode.finished;
          mode.durationMs=o.mode.durationMs||0; mode.endAt=o.mode.endAt||0;
          if(mode.isExam){
            $root.classList.add('app--mode-exam'); setPracticeDisabled(mode.running);
            if(mode.finished){
              $$('.app__card').forEach(c=>checkCard(c,true));
              $$('.app__card input[type="radio"]').forEach(i=>i.disabled=true);
              $root.classList.add('app--finished');
            }else if(mode.running){
              if(mode.endAt<=now()) finishExam(); else startTimer();
            }
          }else{
            result.forEach((r,i)=>{ if(r!==null){ const card=document.querySelector(`.app__card[data-view-index="${i}"]`); if(card) checkCard(card,true); } });
          }
        }
        updateStats(); return true;
      }catch{return false;}
    }
    function clearAll(){ try{ localStorage.removeItem(KEY.state); localStorage.removeItem(KEY.data); localStorage.removeItem(KEY.labels); }catch{} }

    /* ---------- Importación JSON ---------- */
    function validateJSON(arr){
      if(!Array.isArray(arr)) return 'El JSON debe ser un arreglo.';
      for(let i=0;i<arr.length;i++){
        const x=arr[i];
        if(!x||typeof x.q!=='string'||!Array.isArray(x.opts)||x.opts.length!==4||typeof x.ans!=='number'||typeof x.exp!=='string')
          return `Ítem ${i+1} inválido. Requiere {q, opts[4], ans(0–3), exp}.`;
      }
      return null;
    }
    function readJSONFile(file){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>{ try{ res(JSON.parse(String(r.result))); }catch(e){ rej(e);} };
        r.onerror=()=> rej(r.error||new Error('No se pudo leer el archivo.'));
        r.readAsText(file,'utf-8');
      });
    }
    function setDataset(newExam,label='personalizado'){
      EXAM=newExam; EXAM_FP=fp(EXAM); $pillD.textContent=`Dataset: ${label}`;
      resetMode(); saveData(); saveState();
    }

    /* ---------- Exportación CSV ---------- */
    function exportCSV(){
      const rows=[['#','Pregunta','Elegida (letra)','Elegida (texto)','Correcta (letra)','Correcta (texto)','¿Correcta?','¿Corregida?'].join(',')];
      $$('.app__card').forEach((card,i)=>{
        const oi=Number(card.dataset.origIndex), it=EXAM[oi], map={};
        [...card.querySelectorAll('.app__card-option')].forEach((box,k)=>{
          const idx=Number(box.querySelector('input').value);
          const txt=box.querySelector('div').innerText.replace(/^[A-D]\.\s*/,'');
          map[idx]={letter:L[k], text:txt};
        });
        const chosen=answers[i];
        const ch=chosen===null?{letter:'',text:''}:(map[chosen]||{letter:'',text:''});
        const co=map[it.ans]||{letter:'',text:it.opts[it.ans]||''};
        const ok=result[i], ev=result[i]!==null;
        rows.push([ i+1, `"${it.q.replace(/"/g,'""')}"`, ch.letter, `"${(ch.text||'').replace(/"/g,'""')}"`, co.letter, `"${(co.text||'').replace(/"/g,'""')}"`, ok===true?'Sí':(ok===false?'No':''), ev?'Sí':'No' ].join(','));
      });
      const ts=new Date().toISOString().replace(/[:T]/g,'-').split('.')[0];
      download(`examen_${ts}.csv`, rows.join('\n'));
    }

    /* ---------- Importación CSV ---------- */
    function parseCSV(text){
      const rows=[]; let row=[], cell='', q=false;
      for(let i=0;i<text.length;i++){
        const ch=text[i], nx=text[i+1];
        if(q){ if(ch==='"'&&nx==='"'){cell+='"';i++;} else if(ch==='"'){q=false;} else cell+=ch; }
        else{ if(ch==='"'){q=true;} else if(ch===','){row.push(cell);cell='';} else if(ch==='\n'){row.push(cell);rows.push(row);row=[];cell='';} else if(ch!=='\r'){cell+=ch;} }
      }
      if(cell.length||row.length){row.push(cell);rows.push(row);} return rows;
    }
    function summarizeCSV(text){
      $panelCSV.style.display='block'; $sumCSV.innerHTML='';
      const rows=parseCSV(text.trim()); if(!rows.length){ $sumCSV.textContent='CSV vacío.'; return; }
      const header=rows[0].map(h=>h.trim().toLowerCase()), data=rows.slice(1);
      const iCh=header.findIndex(h=>h.includes('elegida')&&h.includes('letra'));
      const iCo=header.findIndex(h=>h.includes('correcta')&&h.includes('letra'));
      let total=0,correct=0,answered=0, fails=[];

      if(iCh!==-1&&iCo!==-1){
        data.forEach((r,i)=>{ const ch=(r[iCh]||'').trim().toUpperCase(), co=(r[iCo]||'').trim().toUpperCase();
          if(['A','B','C','D'].includes(ch)) answered++; if(ch&&co&&ch===co) correct++; total++; if(ch&&co&&ch!==co) fails.push({n:i+1,ch,co});
        });
        $sumCSV.innerHTML=`<p><strong>Formato:</strong> CSV exportado por la app.</p>
          <p><strong>Preguntas:</strong> ${total} | <strong>Respondidas:</strong> ${answered} | <strong>Aciertos:</strong> ${correct} | <strong>Nota:</strong> ${((correct/Math.max(1,total))*10).toFixed(2)}/10</p>
          ${fails.length?`<details><summary>Fallos (${fails.length})</summary><ul>${fails.map(m=>`<li>Preg. ${m.n}: marcó ${m.ch}, correcta ${m.co}</li>`).join('')}</ul></details>`:'<p>Sin fallos 🎉</p>'}`;
        return;
      }

      const toks=text.toUpperCase().match(/[A-D]/g)||[];
      total=EXAM.length; if(!toks.length){ $sumCSV.innerHTML='<p>No se detectaron respuestas (A–D).</p>'; return; }
      toks.slice(0,total).forEach((ch,i)=>{ const oi=order[i], co=L[EXAM[oi].ans]; if(ch===co) correct++; else fails.push({n:i+1,ch,co}); });
      answered=Math.min(toks.length,total);
      $sumCSV.innerHTML=`<p><strong>Formato:</strong> lista simple (A–D).</p>
        <p><em>Ojo:</em> califica según el <strong>orden visible</strong>.</p>
        <p><strong>Preguntas:</strong> ${total} | <strong>Respondidas:</strong> ${answered} | <strong>Aciertos:</strong> ${correct} | <strong>Nota:</strong> ${((correct/Math.max(1,total))*10).toFixed(2)}/10</p>
        ${fails.length?`<details open><summary>Fallos (${fails.length})</summary><ul>${fails.map(m=>`<li>Preg. ${m.n}: marcó ${m.ch}, correcta ${m.co}</li>`).join('')}</ul></details>`:'<p>Sin fallos 🎉</p>'}`;
    }

    /* ---------- Etiquetas examen/repaso (UI) ---------- */
    function applyLabels(){
      const repaso=(labelsMode==='repaso');
      $txtModeSummary.textContent = repaso ? 'Modo repaso' : 'Modo examen';
      $txtModeHint.textContent    = repaso ? 'Feedback inmediato: usa “Comprobar”.' : 'Sin feedback hasta “Finalizar”.';
      $('#btn-start').textContent     = repaso ? 'Iniciar repaso' : 'Iniciar examen';
      $('#btn-finish').textContent    = repaso ? 'Finalizar repaso' : 'Finalizar examen';
      $('#btn-resetmode').textContent = repaso ? 'Reiniciar modo repaso' : 'Reiniciar modo examen';
      $txtSubtitle.textContent   = repaso ? 'Uso 100% local. Importar JSON/CSV, modo repaso y examen, exportar CSV.' :
                                            'Uso 100% local. Importar JSON/CSV, modo repaso y examen, exportar CSV.';
      localStorage.setItem(KEY.labels, labelsMode);
    }
    function swapLabels(){ labelsMode=(labelsMode==='examen'?'repaso':'examen'); applyLabels(); }

    /* ---------- Eventos ---------- */
    document.addEventListener('DOMContentLoaded', ()=>{
      const saved=loadData();
      if(saved){ EXAM=saved.exam; EXAM_FP=fp(EXAM); $pillD.textContent='Dataset: restaurado'; }
      else     { EXAM=DEFAULT_EXAM; EXAM_FP=fp(EXAM); $pillD.textContent='Dataset: por defecto'; }

      applyLabels(); render({shuffleOptions:false, resetOrder:true}); loadState();

      $list.addEventListener('click', e=>{
        const btn=e.target.closest('button'); if(!btn) return;
        const card=e.target.closest('.app__card'); if(!card) return;
        if(btn.dataset.action==='check') checkCard(card);
        if(btn.dataset.action==='clear') clearCard(card);
      });
      $list.addEventListener('change', e=>{
        const inp=e.target.closest('input[type="radio"]'); if(!inp) return;
        const card=e.target.closest('.app__card'); const vi=Number(card.dataset.viewIndex);
        answers[vi]=Number(inp.value); saveState();
      });

      $('#btn-shuffle').addEventListener('click', shuffleAll);
      $('#btn-check-all').addEventListener('click', checkAll);
      $('#btn-reset').addEventListener('click', resetAll);
      $('#btn-export').addEventListener('click', exportCSV);
      $('#btn-clear').addEventListener('click', ()=>{ if(confirm('¿Borrar estado y dataset guardados?')){ try{localStorage.removeItem(KEY.state);localStorage.removeItem(KEY.data);localStorage.removeItem(KEY.labels);}catch{} location.reload(); } });
      $('#btn-swap-label').addEventListener('click', swapLabels);

      $('#btn-load-file').addEventListener('click', async ()=>{
        const f=$('#file-json').files?.[0]; if(!f) return alert('Selecciona un archivo JSON.');
        try{ const json=await (new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>{try{res(JSON.parse(String(r.result)));}catch(e){rej(e);}};r.onerror=()=>rej(r.error||new Error('No se pudo leer.'));r.readAsText(f,'utf-8');}));
             const err=validateJSON(json); if(err) throw new Error(err);
             setDataset(json, f.name||'archivo'); alert('Dataset cargado.'); }
        catch(e){ alert('Error: '+e.message); }
      });
      $('#btn-load-text').addEventListener('click', ()=>{
        const raw=$('#txt-json').value.trim(); if(!raw) return alert('Pega JSON en el cuadro.');
        try{ const json=JSON.parse(raw); const err=validateJSON(json); if(err) throw new Error(err);
             setDataset(json,'pegado'); alert('Dataset cargado.'); }
        catch(e){ alert('JSON inválido: '+e.message); }
      });

      $('#btn-start').addEventListener('click', startExam);
      $('#btn-finish').addEventListener('click', finishExam);
      $('#btn-resetmode').addEventListener('click', resetMode);

      const fileCSV=$('#file-csv');
      $('#btn-import-csv').addEventListener('click', ()=>{ fileCSV.value=''; fileCSV.click(); });
      fileCSV.addEventListener('change', ()=>{
        const f=fileCSV.files&&fileCSV.files[0]; if(!f) return;
        const r=new FileReader();
        r.onload = ()=> summarizeCSV(String(r.result||'')); 
        r.onerror= ()=> alert('No se pudo leer el CSV.');
        r.readAsText(f,'utf-8');
      });
    });
  })();
  </script>
</body>
</html>